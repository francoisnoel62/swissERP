{% extends 'home/viewlist.html' %}

{% load crispy_forms_tags %}

{% block viewlist %}
    <form id="form-container" method="post">
        {% csrf_token %}
        <div class="w-50 mx-auto mt-5">
            <div class="form-row">
                <div class="form-group col-md-6">
                    {{ form.name|as_crispy_field }}
                </div>
                <div class="form-group col-md-6">
                    {{ form.date|as_crispy_field }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.terminated|as_crispy_field }}
                </div>
            </div>
            <table class="table">
                {{ presences.management_form }}

                <tbody id="presences-table">
                    {% for form in presences.forms %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            {% for field in form.visible_fields %}
                                <td>
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {{ field.errors.as_ul }}
                                    {{ field|as_crispy_field }}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button id="add-presence" class="btn btn-light" type="button">Add Another Student</button>
            
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-info">Submit</button>
            <button type="cancel" class="btn btn-danger">Cancel</button>
        </div>
        </div>
    </form>

    <script>
        // Get the table body
        const tableBody = document.getElementById('presences-table');

        // Get the "Add Another Student" button
        const addPresenceButton = document.getElementById('add-presence');

        // Keep track of how many rows have been added
        let rowCount = {{ presences.forms|length }};

        let totalForms = document.getElementById('id_presence_set-TOTAL_FORMS');

        // When the button is clicked, add a new row to the table
        addPresenceButton.addEventListener('click', () => {
            // Clone the last row of the table
            const lastRow = tableBody.lastElementChild;
            const newRow = lastRow.cloneNode(true);

            // Update the form fields in the new row
            const formRegex = /presence_set-(\d|__prefix__)-/gm;
            const newRowHtml = newRow.innerHTML.replace(formRegex, `presence_set-${rowCount}-`);
            newRow.innerHTML = newRowHtml;

            // Append the new row to the table
            tableBody.appendChild(newRow);

            // Increment the row count
            rowCount++;

            // Update the total form count
            totalForms.value = rowCount;
        });

        
        const rows = document.querySelectorAll('tr td div select');

        rows.forEach(row => {
            const select = row.querySelector('select');
            select.addEventListener('change', (event) => {
                const input = row.querySelector('input');
                input.value = event.target.value;

                console.log(input.value);
            });
        });

    </script>
{% endblock %}

